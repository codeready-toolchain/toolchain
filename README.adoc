= CodeReady Toolchain

image:https://goreportcard.com/badge/github.com/codeready-toolchain/toolchain-common[Go Report Card, link="https://goreportcard.com/report/github.com/codeready-toolchain/toolchain-common"]
image:https://godoc.org/github.com/codeready-toolchain/toolchain-common?status.png[GoDoc,link="https://godoc.org/github.com/codeready-toolchain/toolchain-common"]
image:https://codecov.io/gh/codeready-toolchain/toolchain-common/branch/master/graph/badge.svg[Codecov.io,link="https://codecov.io/gh/codeready-toolchain/toolchain-common"]

This repo is for controllers, libs, scripts, make files, etc to be shared between host and member operators.

== Setting Up and Connecting Host and Member Clusters

In a new terminal, execute the following commands
```
$ cd $GOPATH/github.com/codeready-toolchain/host-operator
$ minishift start --profile host
$ make login-as-admin 
$ make create-namespace 
$ make deploy-rbac
$ make deploy-crd
```

```
$ cd $GOPATH/github.com/codeready-toolchain/member-operator
$ minishift start --profile member
$ make login-as-admin 
$ make create-namespace 
$ make deploy-rbac
$ make deploy-crd
$ make add-member-to-host
$ make add-host-to-member
$ make build
$ make vendor
$ export OPERATOR_NAMESPACE=toolchain-member-operator
$ operator-sdk up local --namespace=toolchain-member-operator --verbose
```

Now that we are setup, we can add resources and watch the logs on the member-operator! To do so, open a new terminal and run the following commands
```
$ cd $GOPATH/github.com/codeready-toolchain/host-operator
$ minishift profile set host
$ make use-namespace
$ oc apply -f '/path/to/masteruserrecord.yaml'
$ cd $GOPATH/github.com/codeready-toolchain/member-operator
$ minishift profile set member
$ make use-namespace
$ oc apply -f '/path/to/useraccount.yaml'
```

**Example masteruserrecord.yaml:**

_Note:_ The `targetCluster` field must contain the correct member cluster name.
```
apiVersion: toolchain.dev.openshift.com/v1alpha1
kind: MasterUserRecord
metadata:
  name: example
spec:
  disabled: false
  deprovisioned: false
  userID: 86505192-a386-11e9-ad56-525400ad2b23
  userAccounts:
  - targetCluster: member-192-168-42-61-8443
    syncIndex: 86505a
    spec:
      nsLimit: admin
      userID: 86505192-a386-11e9-ad56-525400ad2b23
      nsTemplateSet:
        tierName: basic
        namespaces:
        - type: ide
          revision: abcdef
        - type: cicd
          revision: abcdef
```

**Example useraccount.yaml:**
```
apiVersion: toolchain.dev.openshift.com/v1alpha1
kind: UserAccount
metadata:
  name: example
spec:
  userID: 86505192-a386-11e9-ad56-525400ad2b23
  disabled: false
  nsLimit: admin
  nsTemplateSet:
    tierName: basic
    namespaces:
    - type: ide
      revision: abcdef
    - type: cicd
      revision: abcdef
```

== Configuring developers.redhat.com Authentication in OpenShift 4 Cluster

Create a secret with Identity Provider credentials:
```
$ oc apply -f deploy/idp_secret.yaml
```
Create an Identity Provider:
```
$ oc apply -f deploy/idp.yaml
```

== Creating User

Create a user, identity and user identity mapping:
```
$ oc apply -f deploy/user.yaml
```

== Scripts

=== add-cluster.sh

The CodeReady Toolchain architecture contains two types of clusters `host` and `member`.
To connect these two clusters together it is necessary to run a script link:scripts/add-cluster.sh[] that takes one argument - type of the cluster to be added.

The script is working with Minishift profiles and expects that there are two clusters (profiles) called `host` and `member`.
To be able to run the script, you need to have both clusters prepared, which means:

- created CRDs
- created ServiceAccount with ClusterRole/ClusterRoleBinding

When the script is executed with parameters `add-cluster.sh member` then it does these steps:

1. goes to the `member` profile
2. takes a secret of the SA (from the `member`)
3. takes API endpoint and cluster name of the `member` cluster from Kube config
4. goes to `host` profile
5. takes cluster name of the `host` cluster from Kube config
5. creates a secret with the SA token taken from the `member`
6. creates `KubeFedCluster` CR representing the added `member`
