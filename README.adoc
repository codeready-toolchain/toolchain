= CodeReady Toolchain

image:https://goreportcard.com/badge/github.com/codeready-toolchain/toolchain-common[Go Report Card, link="https://goreportcard.com/report/github.com/codeready-toolchain/toolchain-common"]
image:https://godoc.org/github.com/codeready-toolchain/toolchain-common?status.png[GoDoc,link="https://godoc.org/github.com/codeready-toolchain/toolchain-common"]
image:https://codecov.io/gh/codeready-toolchain/toolchain-common/branch/master/graph/badge.svg[Codecov.io,link="https://codecov.io/gh/codeready-toolchain/toolchain-common"]

This repo is for controllers, libs, scripts, make files, etc to be shared between host and member operators.

== Setting Up and Connecting Host and Member Operators

In a new terminal, navigate to codeready-toolchain/host-operator directory and execute the following commands
```
$ minishift start --profile toolchain
$ make up-local
^C
```
In the same terminal, navigate to codeready-toolchain/member-operator directory and execute the following commands
```
$ make up-local
^C
$ make add-member-to-host
```
In the same terminal, navigate back to codeready-toolchain/host-operator directory and execute the following commands
```
make add-host-to-member
```
In the same terminal, navigate back to codeready-toolchain/member-operator directory and execute the following commands
```
$ make up-local
```

Now that we are setup, we can add resources and watch the logs on the member-operator! To do so, open a new terminal and run the following commands
```
$ oc project toolchain-host-operator
$ oc apply -f '/path/to/masteruserreord.yaml'
$ oc project toolchain-member-operator
$ oc apply -f '/path/to/useraccount.yaml'
```

== Configuring developers.redhat.com Authentication in OpenShift 4 Cluster

Create a secret with Identity Provider credentials:
```
$ oc apply -f deploy/idp_secret.yaml
```
Create an Identity Provider:
```
$ oc apply -f deploy/idp.yaml
```

== Creating User

Create a user, identity and user identity mapping:
```
$ oc apply -f deploy/user.yaml
```

== Scripts

=== add-cluster.sh

The CodeReady Toolchain architecture contains two types of clusters `host` and `member`.
To connect these two clusters together it is necessary to run a script link:scripts/add-cluster.sh[] that takes one argument - type of the cluster to be added.

The script is working with Minishift profiles and expects that there are two clusters (profiles) called `host` and `member`.
To be able to run the script, you need to have both clusters prepared, which means:

- created CRDs
- created ServiceAccount with ClusterRole/ClusterRoleBinding

When the script is executed with parameters `add-cluster.sh member` then it does these steps:

1. goes to the `member` profile
2. takes a secret of the SA (from the `member`)
3. takes API endpoint and cluster name of the `member` cluster from Kube config
4. goes to `host` profile
5. takes cluster name of the `host` cluster from Kube config
5. creates a secret with the SA token taken from the `member`
6. creates `KubeFedCluster` CR representing the added `member`
